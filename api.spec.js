import { test, expect } from '@playwright/test';
const { request: playwrightRequest } = require('playwright');

const BASE_URL = 'https://api.qa.practiceeasily.com/api/';
const LOGIN_BODY = {
  email: "bhavna.adhav+13@thinkitive.com",
  password: "Pass@123"
};

test.describe('Debug Clinician API Tests', () => {

  // Test 1: Basic connectivity test
  test('1. Basic API Connectivity Test', async () => {
    try {
      console.log('üåê Testing basic API connectivity...');
      console.log(`üîó Base URL: ${BASE_URL}`);
      
      const context = await playwrightRequest.newContext({ baseURL: BASE_URL });
      
      // Try a simple request to see if API is accessible
      const response = await context.post('master/login', {
        data: LOGIN_BODY,
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        }
      });
      
      console.log(`üì° Response Status: ${response.status()}`);
      console.log(`üì° Response Headers:`, response.headers());
      console.log(`üì° Response URL: ${response.url()}`);
      
      if (response.status() === 200) {
        const data = await response.json();
        console.log('‚úÖ API is accessible');
        console.log('üìã Response Data:', JSON.stringify(data, null, 2));
      } else {
        const errorText = await response.text();
        console.log('‚ùå API returned error');
        console.log('üìã Error Response:', errorText);
      }
      
      await context.dispose();
    } catch (error) {
      console.error('‚ùå Basic connectivity test failed:', error);
      throw error;
    }
  });

  // Test 2: Login test with detailed debugging
  test('2. Login Test with Detailed Debugging', async () => {
    try {
      console.log('üîê Testing login with detailed debugging...');
      
      const context = await playwrightRequest.newContext({ 
        baseURL: BASE_URL,
        ignoreHTTPSErrors: true // Add this to ignore SSL issues
      });
      
      console.log('üì§ Sending login request...');
      console.log('üìã Login Body:', JSON.stringify(LOGIN_BODY, null, 2));
      
      const loginResponse = await context.post('master/login', {
        data: LOGIN_BODY,
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        }
      });
      
      console.log(`üì° Login Status: ${loginResponse.status()}`);
      console.log(`üì° Login Headers:`, loginResponse.headers());
      
      if (loginResponse.status() === 200) {
        const loginData = await loginResponse.json();
        console.log('‚úÖ Login successful');
        console.log('üìã Login Response:', JSON.stringify(loginData, null, 2));
        
        // Try different token extraction methods
        const tokenPaths = [
          'data.access_token',
          'accessToken', 
          'access_token',
          'token',
          'data.token',
          'data.accessToken'
        ];
        
        let token = null;
        for (const path of tokenPaths) {
          const pathParts = path.split('.');
          let current = loginData;
          
          for (const part of pathParts) {
            if (current && current[part]) {
              current = current[part];
            } else {
              current = null;
              break;
            }
          }
          
          if (current && typeof current === 'string') {
            token = current;
            console.log(`‚úÖ Found token at path: ${path}`);
            console.log(`üîë Token: ${token.substring(0, 50)}...`);
            break;
          }
        }
        
        if (!token) {
          console.log('‚ùå No token found in response');
          console.log('üîç Available keys:', Object.keys(loginData));
          if (loginData.data) {
            console.log('üîç Available data keys:', Object.keys(loginData.data));
          }
        }
        
        expect(token).toBeDefined();
        
      } else {
        const errorText = await loginResponse.text();
        console.log('‚ùå Login failed');
        console.log('üìã Error Response:', errorText);
        throw new Error(`Login failed with status ${loginResponse.status()}: ${errorText}`);
      }
      
      await context.dispose();
    } catch (error) {
      console.error('‚ùå Login test failed:', error);
      throw error;
    }
  });

  // Test 3: Full authentication test
  test('3. Full Authentication Test', async () => {
    try {
      console.log('üîê Testing full authentication flow...');
      
      // Step 1: Login
      const loginContext = await playwrightRequest.newContext({ 
        baseURL: BASE_URL,
        ignoreHTTPSErrors: true
      });
      
      const loginResponse = await loginContext.post('master/login', {
        data: LOGIN_BODY,
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        }
      });
      
      expect(loginResponse.status()).toBe(200);
      const loginData = await loginResponse.json();
      
      const accessToken = 
        loginData.data?.access_token ||
        loginData.accessToken ||
        loginData.access_token ||
        loginData.token;
      
      expect(accessToken).toBeDefined();
      console.log(`‚úÖ Login successful. Token: ${accessToken.substring(0, 50)}...`);
      
      // Step 2: Create authenticated context
      console.log('üîß Creating authenticated context...');
      const apiContext = await playwrightRequest.newContext({
        baseURL: BASE_URL,
        extraHTTPHeaders: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        },
        ignoreHTTPSErrors: true
      });
      
      // Step 3: Test authenticated request
      console.log('üß™ Testing authenticated request...');
      
      // Try different endpoints to see which one works
      const testEndpoints = [
        'master/clinician?page=0&size=10',
        'master/clinician',
        'clinician?page=0&size=10',
        'clinician'
      ];
      
      for (const endpoint of testEndpoints) {
        try {
          console.log(`üîç Testing endpoint: ${endpoint}`);
          const testResponse = await apiContext.get(endpoint);
          console.log(`üì° Status: ${testResponse.status()}`);
          
          if (testResponse.status() === 200) {
            const testData = await testResponse.json();
            console.log(`‚úÖ Endpoint ${endpoint} works!`);
            console.log('üìã Response:', JSON.stringify(testData, null, 2));
            break;
          } else {
            const errorText = await testResponse.text();
            console.log(`‚ùå Endpoint ${endpoint} failed: ${errorText}`);
          }
        } catch (error) {
          console.log(`‚ùå Endpoint ${endpoint} error:`, error);
        }
      }
      
      await loginContext.dispose();
      await apiContext.dispose();
      
    } catch (error) {
      console.error('‚ùå Authentication test failed:', error);
      throw error;
    }
  });

  // Test 4: Simple add clinician test
  test('4. Simple Add Clinician Test', async () => {
    try {
      console.log('üë®‚Äç‚öïÔ∏è Testing simple add clinician...');
      
      // Login
      const loginContext = await playwrightRequest.newContext({ 
        baseURL: BASE_URL,
        ignoreHTTPSErrors: true
      });
      
      const loginResponse = await loginContext.post('master/login', {
        data: LOGIN_BODY,
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        }
      });
      
      expect(loginResponse.status()).toBe(200);
      const loginData = await loginResponse.json();
      const accessToken = 
        loginData.data?.access_token ||
        loginData.accessToken ||
        loginData.access_token ||
        loginData.token;
      
      expect(accessToken).toBeDefined();
      console.log(`‚úÖ Login successful`);
      
      // Create authenticated context
      const apiContext = await playwrightRequest.newContext({
        baseURL: BASE_URL,
        extraHTTPHeaders: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
        },
        ignoreHTTPSErrors: true
      });
      
      // Generate unique data
      const timestamp = Date.now();
      const uniqueData = {
        email: `test${timestamp}@mailinator.com`,
        phone: `+1234567${timestamp.toString().slice(-4)}`,
        npi: `12345678${timestamp.toString().slice(-2)}`
      };
      
      // Minimal clinician data
      const clinicianData = {
        firstName: "Test",
        lastName: "User",
        emailId: uniqueData.email,
        contactNumber: uniqueData.phone,
        npiNumber: uniqueData.npi,
        locationUuids: ["ed27ea30-fdfd-428c-8be5-47fb83cdf050"],
        languagesSpoken: ["English"],
        supervisorClinicianId: "f73a9b5b-4036-4ec5-b0ff-5fc400f32c31",
        roles: ["PSYCHOTHERAPIST"],
        email: uniqueData.email
      };
      
      console.log('üì§ Sending add clinician request...');
      console.log('üìã Clinician Data:', JSON.stringify(clinicianData, null, 2));
      
      const addResponse = await apiContext.post('master/clinician', {
        data: clinicianData
      });
      
      console.log(`üì° Add Status: ${addResponse.status()}`);
      console.log(`üì° Add Headers:`, addResponse.headers());
      
      if (addResponse.status() === 200 || addResponse.status() === 201) {
        const addData = await addResponse.json();
        console.log('‚úÖ Add clinician successful');
        console.log('üìã Add Response:', JSON.stringify(addData, null, 2));
        
        // Try to extract ID
        const clinicianId = 
          addData.data?.uuid ||
          addData.data?.id ||
          addData.uuid ||
          addData.id;
        
        if (clinicianId) {
          console.log(`üÜî Clinician ID: ${clinicianId}`);
        } else {
          console.log('‚ùå Could not extract clinician ID');
          console.log('üîç Available keys:', Object.keys(addData));
          if (addData.data) {
            console.log('üîç Available data keys:', Object.keys(addData.data));
          }
        }
        
      } else {
        const errorText = await addResponse.text();
        console.log('‚ùå Add clinician failed');
        console.log('üìã Error Response:', errorText);
      }
      
      await loginContext.dispose();
      await apiContext.dispose();
      
    } catch (error) {
      console.error('‚ùå Add clinician test failed:', error);
      throw error;
    }
  });

  // Test 5: Network and SSL test
  test('5. Network and SSL Test', async () => {
    try {
      console.log('üåê Testing network and SSL...');
      
      // Test with different configurations
      const configs = [
        { ignoreHTTPSErrors: false, name: 'Standard SSL' },
        { ignoreHTTPSErrors: true, name: 'Ignore SSL Errors' }
      ];
      
      for (const config of configs) {
        console.log(`\nüß™ Testing with ${config.name}...`);
        
        try {
          const context = await playwrightRequest.newContext({
            baseURL: BASE_URL,
            ignoreHTTPSErrors: config.ignoreHTTPSErrors
          });
          
          const response = await context.post('master/login', {
            data: LOGIN_BODY,
            headers: {
              'Content-Type': 'application/json',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
            }
          });
          
          console.log(`üì° ${config.name} Status: ${response.status()}`);
          
          if (response.status() === 200) {
            console.log(`‚úÖ ${config.name} works!`);
          } else {
            const errorText = await response.text();
            console.log(`‚ùå ${config.name} failed: ${errorText}`);
          }
          
          await context.dispose();
          
        } catch (error) {
          console.log(`‚ùå ${config.name} error:`, error);
        }
      }
      
    } catch (error) {
      console.error('‚ùå Network test failed:', error);
      throw error;
    }
  });

  // Test 6: Environment check
  test('6. Environment Check', async () => {
    console.log('üîç Environment Information:');
    console.log(`üìç Base URL: ${BASE_URL}`);
    console.log(`üìß Login Email: ${LOGIN_BODY.email}`);
    console.log(`üîí Password: ${LOGIN_BODY.password.substring(0, 4)}...`);
    console.log(`üåê Node.js Version: ${process.version}`);
    console.log(`üìÖ Current Time: ${new Date().toISOString()}`);
    
    // Test URL parsing
    try {
      const url = new URL(BASE_URL);
      console.log(`‚úÖ URL is valid`);
      console.log(`üîó Protocol: ${url.protocol}`);
      console.log(`üîó Host: ${url.host}`);
      console.log(`üîó Pathname: ${url.pathname}`);
    } catch (error) {
      console.log(`‚ùå URL parsing failed:`, error);
    }
  });

});